{% extends "base.html" %}

{% block title %}Analysis Results - ClausePilot{% endblock %}
{% block page_title %}Contract Analysis Results{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid">
  
  <!-- Action Bar -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-2">
          <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
          <li class="breadcrumb-item active">Analysis Results</li>
        </ol>
      </nav>
      <h1 class="h4 mb-1 fw-bold">{{ filename }}</h1>
      <p class="text-muted mb-0 small">Analyzed on {{ analyzed_at }}</p>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-primary" href="{{ url_for('index') }}">
        <i class="bi bi-arrow-left-circle me-1"></i>New Analysis
      </a>
      <a class="btn btn-primary" href="{{ url_for('download_report', filename=filename) }}">
        <i class="bi bi-download me-1"></i>Download Report
      </a>
    </div>
  </div>

  <!-- Overall Risk Score Card -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm rounded-4 bg-gradient-primary text-white">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="fw-bold mb-3">Overall Contract Risk Score</h5>
              <p class="mb-2 opacity-90">{{ risk_score_breakdown.scoring_method }}</p>
              <div class="d-flex flex-wrap gap-4 mt-3">
                <div>
                  <small class="opacity-75">Total Risk Score</small>
                  <div class="fs-6 fw-semibold">{{ risk_score_breakdown.total_severity_score }}</div>
                </div>
                <div>
                  <small class="opacity-75">Max Possible</small>
                  <div class="fs-6 fw-semibold">{{ risk_score_breakdown.max_possible_score }}</div>
                </div>
                <div>
                  <small class="opacity-75">Normalized</small>
                  <div class="fs-6 fw-semibold">{{ risk_score_breakdown.normalized_score }}</div>
                </div>
                {% if risk_score_breakdown.high_risk_count > 0 %}
                <div>
                  <small class="opacity-75">High-Risk Patterns</small>
                  <div class="fs-6 fw-semibold text-danger">{{ risk_score_breakdown.high_risk_count }}</div>
                </div>
                {% endif %}
              </div>
            </div>
            <div class="col-md-4 text-center">
              <div class="risk-score-display">
                {{ overall_risk_score }}<span class="fs-3">%</span>
              </div>
              <div class="opacity-90">Risk Level</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
      <div class="stat-card-modern">
        <div class="stat-icon bg-primary-subtle text-primary">
          <i class="bi bi-file-text"></i>
        </div>
        <div>
          <div class="stat-label">Total Clauses</div>
          <div class="stat-value">{{ summary.total_clauses }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="stat-card-modern">
        <div class="stat-icon bg-danger-subtle text-danger">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <div>
          <div class="stat-label">High Risk</div>
          <div class="stat-value">{{ summary.high_risk_count }} <span class="stat-percent">({{ summary.severity_percentages.High }}%)</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="stat-card-modern">
        <div class="stat-icon bg-warning-subtle text-warning">
          <i class="bi bi-exclamation-circle-fill"></i>
        </div>
        <div>
          <div class="stat-label">Medium Risk</div>
          <div class="stat-value">{{ summary.medium_risk_count }} <span class="stat-percent">({{ summary.severity_percentages.Medium }}%)</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="stat-card-modern">
        <div class="stat-icon bg-success-subtle text-success">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <div>
          <div class="stat-label">Low/Neutral Risk</div>
          <div class="stat-value">{{ summary.low_risk_count + summary.neutral_count }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Executive Summary & Impact Breakdown -->
  <div class="row g-4 mb-4">
    <div class="col-lg-7">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-header bg-white border-0 pt-4 px-4">
          <h5 class="fw-bold mb-0"><i class="bi bi-file-earmark-text me-2 text-primary"></i>Executive Summary</h5>
        </div>
        <div class="card-body px-4">
          <ul class="executive-summary-list">
            {% for line in executive_summary %}
              <li>{{ line }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-header bg-white border-0 pt-4 px-4">
          <h5 class="fw-bold mb-0"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>Risk Impact Weights</h5>
        </div>
        <div class="card-body px-4">
          <p class="text-muted small mb-3">Each risk category has a weighted impact factor used in scoring:</p>
          <div class="impact-weight-list">
            <div class="impact-weight-item">
              <span class="fw-semibold">Liability Risk</span>
              <span class="badge bg-danger-subtle text-danger">{{ risk_score_breakdown.category_weights['Liability Risk'] }}</span>
            </div>
            <div class="impact-weight-item">
              <span class="fw-semibold">Termination Risk</span>
              <span class="badge bg-danger-subtle text-danger">{{ risk_score_breakdown.category_weights['Termination Risk'] }}</span>
            </div>
            <div class="impact-weight-item">
              <span class="fw-semibold">IP Risk</span>
              <span class="badge bg-primary-subtle text-primary">{{ risk_score_breakdown.category_weights['IP Risk'] }}</span>
            </div>
            <div class="impact-weight-item">
              <span class="fw-semibold">Data Privacy Risk</span>
              <span class="badge bg-warning-subtle text-warning">{{ risk_score_breakdown.category_weights['Data Privacy Risk'] }}</span>
            </div>
            <div class="impact-weight-item">
              <span class="fw-semibold">Payment Risk</span>
              <span class="badge bg-warning-subtle text-warning">{{ risk_score_breakdown.category_weights['Payment Risk'] }}</span>
            </div>
            <div class="impact-weight-item">
              <span class="fw-semibold">Neutral</span>
              <span class="badge bg-secondary-subtle text-secondary">{{ risk_score_breakdown.category_weights['Neutral'] }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="row g-4 mb-4">
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-header bg-white border-0 pt-4 px-4">
          <h6 class="fw-bold mb-0">Risk Label Distribution</h6>
        </div>
        <div class="card-body px-4">
          <canvas id="riskLabelPieChart" height="220"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-header bg-white border-0 pt-4 px-4">
          <h6 class="fw-bold mb-0">Severity Distribution</h6>
        </div>
        <div class="card-body px-4">
          <canvas id="severityBarChart" height="220"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm rounded-4 h-100">
        <div class="card-header bg-white border-0 pt-4 px-4">
          <h6 class="fw-bold mb-0">Confidence Calibration</h6>
        </div>
        <div class="card-body px-4">
          <canvas id="confidenceHistogramChart" height="220"></canvas>
          <p class="small text-muted mt-2 mb-0"><i class="bi bi-info-circle"></i> Dashed line marks high confidence threshold ({{ high_conf_threshold }})</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Clause Filters & Search -->
  <div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-header bg-white border-0 pt-4 px-4">
      <h5 class="fw-bold mb-0"><i class="bi bi-funnel me-2 text-primary"></i>Filter & Search Clauses</h5>
    </div>
    <div class="card-body px-4">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label small fw-semibold">Search by Keyword</label>
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0">
              <i class="bi bi-search"></i>
            </span>
            <input id="searchInput" type="text" class="form-control border-start-0 ps-0" placeholder="Search clause text...">
          </div>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold">Risk Label</label>
          <select id="riskFilter" class="form-select">
            <option value="">All Labels</option>
            <option value="Liability Risk">Liability Risk</option>
            <option value="Termination Risk">Termination Risk</option>
            <option value="IP Risk">IP Risk</option>
            <option value="Payment Risk">Payment Risk</option>
            <option value="Data Privacy Risk">Data Privacy Risk</option>
            <option value="Neutral">Neutral</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small fw-semibold">Severity</label>
          <select id="severityFilter" class="form-select">
            <option value="">All Severity</option>
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
            <option value="None">None</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small fw-semibold">Sort By</label>
          <select id="sortSelect" class="form-select">
            <option value="confidence">Confidence (High to Low)</option>
            <option value="length">Clause Length</option>
            <option value="risk">Risk Type (A-Z)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <div id="noResultsMessage" class="alert alert-info d-none">
    <i class="bi bi-info-circle me-2"></i>No clauses match the selected filters. Try adjusting your search criteria.
  </div>

  <!-- Clauses List -->
  <div class="mb-3">
    <h5 class="fw-bold"><i class="bi bi-list-ul me-2 text-primary"></i>Contract Clauses ({{ results|length }})</h5>
    <p class="text-muted small mb-0">Click any clause to expand and view full text with SHAP explainability</p>
  </div>

  <div class="accordion clause-accordion" id="clausesAccordion">
    {% for item in results %}
    <div
      class="accordion-item clause-card border-0 shadow-sm rounded-4 mb-3"
      data-label="{{ item.label }}"
      data-severity="{{ item.severity }}"
      data-confidence="{{ item.confidence }}"
      data-length="{{ item.clause|length }}"
    >
      <h2 class="accordion-header" id="heading{{ item.id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ item.id }}">
          <div class="w-100 d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
            <div class="clause-preview-text" data-original="{{ item.clause_preview | e }}">
              <i class="bi bi-file-text me-2 text-muted"></i>{{ item.clause_preview }}
            </div>
            <div class="d-flex flex-wrap gap-2 align-items-center clause-badges">
              <span class="badge {{ item.risk_badge_class }} risk-badge" 
                    data-bs-toggle="tooltip" 
                    data-bs-title="Risk Category">
                {{ item.label }}
              </span>
              <span class="badge {{ item.severity_badge_class }} severity-badge"
                    data-bs-toggle="tooltip" 
                    data-bs-title="Severity Level">
                {{ item.severity }}
              </span>
              <span class="badge bg-light text-dark confidence-badge"
                    data-bs-toggle="tooltip" 
                    data-bs-title="Model Confidence">
                <i class="bi bi-speedometer2"></i> {{ item.confidence_pct }}%
              </span>
            </div>
          </div>
        </button>
      </h2>
      <div id="collapse{{ item.id }}" class="accordion-collapse collapse" data-bs-parent="#clausesAccordion">
        <div class="accordion-body p-4">
          
          <!-- Clause Metadata -->
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              <div class="meta-box">
                <i class="bi bi-shield-check text-primary me-2"></i>
                <div>
                  <div class="small text-muted">Risk Label</div>
                  <div class="fw-semibold">{{ item.label }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="meta-box">
                <i class="bi bi-flag text-warning me-2"></i>
                <div>
                  <div class="small text-muted">Severity</div>
                  <div class="fw-semibold">{{ item.severity }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="meta-box">
                <i class="bi bi-percent text-success me-2"></i>
                <div>
                  <div class="small text-muted">Confidence</div>
                  <div class="fw-semibold">{{ item.confidence_pct }}%</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Full Clause Text -->
          <div class="clause-section mb-4">
            <h6 class="fw-bold mb-2"><i class="bi bi-file-text me-2"></i>Full Clause Text</h6>
            <div class="clause-text-box" id="full-clause-{{ item.id }}" data-original="{{ item.clause | e }}">
              {{ item.clause }}
            </div>
          </div>

          <!-- SHAP Explainability -->
          <div class="clause-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="fw-bold mb-0"><i class="bi bi-lightbulb me-2"></i>AI Explainability (SHAP)</h6>
              <button type="button" 
                      class="btn btn-primary btn-sm explain-btn" 
                      data-id="{{ item.id }}" 
                      data-clause="{{ item.clause | e }}">
                <i class="bi bi-cpu me-1"></i>Generate Explanation
              </button>
            </div>
            
            <div id="explain-status-{{ item.id }}" class="alert alert-info small mb-3">
              <i class="bi bi-info-circle me-1"></i>Click "Generate Explanation" to see which words influenced this prediction.
            </div>
            
            <div id="explain-content-{{ item.id }}" class="d-none">
              <div class="row g-3">
                <div class="col-md-12 mb-2">
                  <div class="shap-box">
                    <div class="small fw-semibold text-muted mb-2">Top Contributing Words:</div>
                    <div id="explain-words-{{ item.id }}" class="fw-semibold"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="shap-box shap-positive">
                    <i class="bi bi-arrow-up-circle-fill text-success me-1"></i>
                    <span class="small fw-semibold">Positive Contributors:</span>
                    <div id="explain-positive-{{ item.id }}" class="small mt-1"></div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="shap-box shap-negative">
                    <i class="bi bi-arrow-down-circle-fill text-danger me-1"></i>
                    <span class="small fw-semibold">Negative Contributors:</span>
                    <div id="explain-negative-{{ item.id }}" class="small mt-1"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>

</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<!-- Data from Flask -->
<script id="pie-labels-json" type="application/json">{{ pie_labels | tojson }}</script>
<script id="pie-values-json" type="application/json">{{ pie_values | tojson }}</script>
<script id="bar-labels-json" type="application/json">{{ bar_labels | tojson }}</script>
<script id="bar-values-json" type="application/json">{{ bar_values | tojson }}</script>
<script id="conf-labels-json" type="application/json">{{ confidence_hist_labels | tojson }}</script>
<script id="conf-counts-json" type="application/json">{{ confidence_hist_counts | tojson }}</script>
<script id="high-threshold-json" type="application/json">{{ high_conf_threshold | tojson }}</script>

<script>
  // Parse data
  const pieLabels = JSON.parse(document.getElementById("pie-labels-json").textContent);
  const pieValues = JSON.parse(document.getElementById("pie-values-json").textContent);
  const barLabels = JSON.parse(document.getElementById("bar-labels-json").textContent);
  const barValues = JSON.parse(document.getElementById("bar-values-json").textContent);
  const confidenceHistLabels = JSON.parse(document.getElementById("conf-labels-json").textContent);
  const confidenceHistCounts = JSON.parse(document.getElementById("conf-counts-json").textContent);
  const highConfidenceThreshold = JSON.parse(document.getElementById("high-threshold-json").textContent);

  // Initialize Bootstrap tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Chart.js - Risk Label Pie Chart (Doughnut style)
  const pieCtx = document.getElementById("riskLabelPieChart");
  if (pieCtx) {
    new Chart(pieCtx, {
      type: "doughnut",
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieValues,
          backgroundColor: [
            "rgba(220, 38, 38, 0.8)",   // Liability - red
            "rgba(234, 88, 12, 0.8)",   // Termination - orange
            "rgba(107, 33, 168, 0.8)",  // IP - purple
            "rgba(161, 98, 7, 0.8)",    // Payment - yellow
            "rgba(37, 99, 235, 0.8)",   // Data Privacy - blue
            "rgba(107, 114, 128, 0.8)"  // Neutral - gray
          ],
          borderWidth: 2,
          borderColor: "#fff"
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              padding: 15,
              font: { size: 11 }
            }
          }
        }
      }
    });
  }

  // Chart.js - Severity Bar Chart
  const barCtx = document.getElementById("severityBarChart");
  if (barCtx) {
    new Chart(barCtx, {
      type: "bar",
      data: {
        labels: barLabels,
        datasets: [{
          label: "Number of Clauses",
          data: barValues,
          backgroundColor: [
            "rgba(220, 38, 38, 0.8)",   // High - red
            "rgba(234, 179, 8, 0.8)",   // Medium - yellow
            "rgba(34, 197, 94, 0.8)",   // Low - green
            "rgba(107, 114, 128, 0.8)"  // None - gray
          ],
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  // Chart.js - Confidence Histogram
  const histCtx = document.getElementById("confidenceHistogramChart");
  if (histCtx) {
    const thresholdBin = Math.floor(highConfidenceThreshold * confidenceHistLabels.length);
    
    const thresholdLinePlugin = {
      id: "thresholdLinePlugin",
      afterDatasetsDraw(chart) {
        const { ctx, chartArea, scales } = chart;
        const xScale = scales.x;
        const xPos = xScale.getPixelForValue(thresholdBin);
        ctx.save();
        ctx.setLineDash([6, 4]);
        ctx.strokeStyle = "#dc2626";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(xPos, chartArea.top);
        ctx.lineTo(xPos, chartArea.bottom);
        ctx.stroke();
        ctx.restore();
      }
    };

    new Chart(histCtx, {
      type: "bar",
      data: {
        labels: confidenceHistLabels,
        datasets: [{
          label: "Count",
          data: confidenceHistCounts,
          backgroundColor: confidenceHistLabels.map((_, idx) => 
            idx >= thresholdBin ? "rgba(220, 38, 38, 0.8)" : "rgba(100, 116, 139, 0.8)"
          ),
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: { precision: 0 }
          }
        },
        plugins: {
          legend: { display: false }
        }
      },
      plugins: [thresholdLinePlugin]
    });
  }

  // Filter and Search functionality
  const searchInput = document.getElementById("searchInput");
  const riskFilter = document.getElementById("riskFilter");
  const severityFilter = document.getElementById("severityFilter");
  const sortSelect = document.getElementById("sortSelect");
  const accordion = document.getElementById("clausesAccordion");
  const noResultsMessage = document.getElementById("noResultsMessage");

  function escapeRegex(text) {
    return text.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function highlightText(text, keyword) {
    const safe = escapeRegex(keyword.trim());
    if (!safe) return escapeHtml(text);
    const re = new RegExp(`(${safe})`, "gi");
    return escapeHtml(text).replace(re, '<mark class="search-highlight">$1</mark>');
  }

  function sortCards(cards, mode) {
    return cards.sort((a, b) => {
      if (mode === "length") {
        return Number(b.dataset.length) - Number(a.dataset.length);
      }
      if (mode === "risk") {
        return a.dataset.label.localeCompare(b.dataset.label);
      }
      return Number(b.dataset.confidence) - Number(a.dataset.confidence);
    });
  }

  function applyFiltersAndSearch() {
    const query = searchInput.value.trim().toLowerCase();
    const selectedRisk = riskFilter.value;
    const selectedSeverity = severityFilter.value;

    const cards = Array.from(accordion.querySelectorAll(".clause-card"));
    const sortedCards = sortCards(cards, sortSelect.value);
    sortedCards.forEach(card => accordion.appendChild(card));

    let visibleCount = 0;
    cards.forEach(card => {
      const label = card.dataset.label;
      const severity = card.dataset.severity;
      const fullTextEl = card.querySelector(".clause-text-box");
      const previewEl = card.querySelector(".clause-preview-text");
      const baseFull = fullTextEl.dataset.original || fullTextEl.textContent;
      const basePreview = previewEl.dataset.original || previewEl.textContent;
      
      const textMatch = !query || baseFull.toLowerCase().includes(query);
      const riskMatch = !selectedRisk || selectedRisk === label;
      const severityMatch = !selectedSeverity || selectedSeverity === severity;

      const show = textMatch && riskMatch && severityMatch;
      card.classList.toggle("d-none", !show);

      if (show) {
        visibleCount += 1;
        if (query) {
          fullTextEl.innerHTML = highlightText(baseFull, query);
          previewEl.innerHTML = highlightText(basePreview, query);
        } else {
          fullTextEl.textContent = baseFull;
          previewEl.textContent = basePreview;
        }
      }
    });

    noResultsMessage.classList.toggle("d-none", visibleCount > 0);
  }

  // SHAP Explanation
  function highlightTokens(text, tokens) {
    let html = escapeHtml(text);
    tokens.forEach(token => {
      const safe = escapeRegex(token);
      if (!safe) return;
      const re = new RegExp(`\\b(${safe})\\b`, "gi");
      html = html.replace(re, '<span class="token-highlight">$1</span>');
    });
    return html;
  }

  async function runExplanation(btn) {
    const id = btn.dataset.id;
    const clause = btn.dataset.clause;
    const status = document.getElementById(`explain-status-${id}`);
    const wordsBox = document.getElementById(`explain-words-${id}`);
    const positiveBox = document.getElementById(`explain-positive-${id}`);
    const negativeBox = document.getElementById(`explain-negative-${id}`);
    const clauseBox = document.getElementById(`full-clause-${id}`);
    const contentBox = document.getElementById(`explain-content-${id}`);

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Generating...';
    status.className = "alert alert-info small mb-3";
    status.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Generating SHAP explanation...';
    contentBox.classList.add('d-none');

    try {
      const res = await fetch("{{ url_for('explain_clause') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ clause })
      });
      const payload = await res.json();
      
      if (!res.ok) {
        status.className = "alert alert-danger small mb-3";
        status.innerHTML = `<i class="bi bi-x-circle me-1"></i>${payload.error || "Failed to generate explanation."}`;
        return;
      }

      const tokens = payload.top_contributing_words || [];
      const positiveTokens = payload.top_positive_words || [];
      const negativeTokens = payload.top_negative_words || [];
      const threshold = payload.shap_threshold;
      
      status.className = "alert alert-success small mb-3";
      status.innerHTML = `<i class="bi bi-check-circle me-1"></i>Explanation generated successfully${threshold !== undefined ? ` (|SHAP| â‰¥ ${threshold})` : ''}`;
      
      wordsBox.textContent = tokens.length ? tokens.join(", ") : "No top words available.";
      positiveBox.textContent = positiveTokens.length ? positiveTokens.join(", ") : "None";
      negativeBox.textContent = negativeTokens.length ? negativeTokens.join(", ") : "None";
      
      clauseBox.innerHTML = highlightTokens(clause, tokens);
      contentBox.classList.remove('d-none');
      
    } catch (err) {
      status.className = "alert alert-danger small mb-3";
      status.innerHTML = '<i class="bi bi-x-circle me-1"></i>Error generating explanation.';
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-cpu me-1"></i>Generate Explanation';
    }
  }

  // Event listeners
  searchInput.addEventListener("input", applyFiltersAndSearch);
  riskFilter.addEventListener("change", applyFiltersAndSearch);
  severityFilter.addEventListener("change", applyFiltersAndSearch);
  sortSelect.addEventListener("change", applyFiltersAndSearch);

  document.querySelectorAll(".explain-btn").forEach(btn => {
    btn.addEventListener("click", () => runExplanation(btn));
  });

  // Initial filter application
  applyFiltersAndSearch();
</script>
{% endblock %}
